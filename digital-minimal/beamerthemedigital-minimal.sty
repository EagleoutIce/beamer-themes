%% Version: 1.0
%% Author:  Florian Sihler, 3.02.2021
%% This package is a beamer theme to be used with the latex beamer-class.
%% Dev-Notes: All internal commands and registers will be prefixed with 'btdm@'
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{beamerthemedigital-minimal}[2019/08/17 v1.0.0 Latex-Beamertheme digital-minimal]

% die idee: gaanz unten ein dünner grauer block der alle Metainformationen enthält, oben nur ein Titel
% break Folien für Sections mit simpler Dreiecks optic und übersicht über TOC -- neues Tut design

\RequirePackage{kvoptions}
\SetupKeyvalOptions{family=btdm,prefix=btdm@}

\newif\ifbtdm@footfade@
\DeclareVoidOption{nofootfade}{\btdm@footfade@false} \DeclareVoidOption{footfade}{\btdm@footfade@true}
% todo: maybe change to something more flexible with beamer colorthemes
\DeclareVoidOption{darkmode}{\def\btdm@mode{darkmode}}
\DeclareVoidOption{lightmode}{\def\btdm@mode{lightmode}}
\DeclareVoidOption{lightmode-fill}{\def\btdm@mode{lightmode-fill}}
\DeclareVoidOption{darkmode-soft}{\def\btdm@mode{darkmode-soft}}

\newif\ifbtdm@largetrig@
\DeclareVoidOption{small-triangle}{\btdm@largetrig@false}
\DeclareVoidOption{large-triangle}{\btdm@largetrig@true}

% bibliography
\newif\ifbtdm@bibliography@ \btdm@bibliography@true % default: yes/ifloaded
\DeclareVoidOption{nobib}{\btdm@bibliography@false}
\DeclareVoidOption{showbib}{\btdm@bibliography@true}

\DeclareStringOption[\btdm@defaultcolor]{color}[\btdm@defaultcolor]
\ProcessKeyvalOptions*

% \RequirePackage[defaultfam,light,tabular,lining]{montserrat}
\RequirePackage[sfdefault,proportional,lining,scaled=.95]{FiraSans}
\RequirePackage[scaled=.95]{FiraMono}

% TODO: set all to Fira Family
% TODO: check Londrina Solid
\def\btdm@sbseries{\fontseries{sb}\selectfont}

\RequirePackage{sfmath} % TODO: no-libs option
% update math figures

% TODO: titlepage

\RequirePackage{relsize}

\RequirePackage{pgf,pgffor} % i do need it... always :)
\RequirePackage{fontawesome} % foot symbols

% \definecolor{btdm@primary@default@dark}{RGB}{136, 247, 226} % rgb(136, 247, 226)
% \definecolor{btdm@primary@default@dark}{RGB}{245,235,103} % rgb(245,235,103) % todo
\definecolor{btdm@primary@default@dark}{RGB}{255,161,92} % rgb(255,161,92)
% \definecolor{btdm@primary@default@dark}{RGB}{68,212,146} % rgb(68,212,146)
% \definecolor{btdm@primary@default@dark}{RGB}{250,35,62} % rgb(250,35,62)
\definecolor{btdm@primary@default@light}{RGB}{51,93,126}  % taken from lucy

\@namedef{btdm@mode@darkmode}{
\def\btdm@defaultcolor{btdm@primary@default@dark}
\colorlet{btdm@primary}{\btdm@color}
\colorlet{btdm@text}{black!1!white}
\colorlet{btdm@softtext}{btdm@primary!35!white}
\colorlet{btdm@frametitle}{btdm@text}
\colorlet{btdm@block}{darkgray!60!black!99!btdm@primary}
\colorlet{btdm@background}{darkgray!99!white!99!btdm@primary}
\colorlet{btdm@border@up}{darkgray!90!black!99!btdm@primary}
\colorlet{btdm@border@down}{darkgray!90!black!99!btdm@primary}
\colorlet{btdm@foot}{gray}
}
\@namedef{btdm@mode@lightmode}{
\def\btdm@defaultcolor{btdm@primary@default@light}
\colorlet{btdm@primary}{\btdm@color}
\colorlet{btdm@text}{black!99!gray}
\colorlet{btdm@softtext}{gray!42!white!95!btdm@primary}
\colorlet{btdm@frametitle}{btdm@primary}
\colorlet{btdm@border@up}{lightgray!12!white}
\colorlet{btdm@block}{black!90!btdm@primary!90!btdm@border@up}
\colorlet{btdm@background}{white!99!gray}
\colorlet{btdm@border@down}{lightgray!12!white}
\colorlet{btdm@foot}{gray}
}
\@namedef{btdm@mode@lightmode-filled}{
\def\btdm@defaultcolor{btdm@primary@default@light}
\colorlet{btdm@primary}{\btdm@color}
\colorlet{btdm@text}{black!99!gray}
\colorlet{btdm@softtext}{gray!42!white!95!btdm@primary}
\colorlet{btdm@frametitle}{btdm@primary}
\colorlet{btdm@border@up}{lightgray!12!white}
\colorlet{btdm@block}{black!90!btdm@primary!90!btdm@border@up}
\colorlet{btdm@background}{white!99!gray}
\colorlet{btdm@border@down}{lightgray!12!white}
\colorlet{btdm@foot}{gray}
}
\@namedef{btdm@mode@darkmode-soft}{
\def\btdm@defaultcolor{btdm@primary@default@dark}
\colorlet{btdm@primary}{\btdm@color}
\definecolor{btdm@text}{RGB}{173,186,199}
\colorlet{btdm@frametitle}{btdm@text}
\definecolor{btdm@background}{RGB}{34,39,46}
\definecolor{btdm@border@up}{RGB}{28,33,40}
\colorlet{btdm@border@down}{btdm@border@up}
\colorlet{btdm@softtext}{btdm@primary!26!btdm@background}
\colorlet{btdm@block}{btdm@border@up!80!black!99!btdm@primary}
\colorlet{btdm@foot}{btdm@text!36!btdm@border@down}
}

% execute mode
\csname btdm@mode@\btdm@mode\endcsname

\setbeamercolor{palette primary}{fg=btdm@primary}

\setbeamerfont{structure}{series=\btdm@sbseries}
\setbeamerfont{frametitle}{parent=structure,size=\Large}
\setbeamerfont{title}{parent=structure,size=\Huge}
\setbeamerfont{subtitle}{shape=\slshape,size=\LARGE}
% active section in the footline, custom
\setbeamerfont{active section in head/foot}{series=\btdm@sbseries}

\setbeamercolor{structure}{fg=btdm@primary}
\setbeamercolor{title}{fg=btdm@primary}
\setbeamercolor{description item}{fg=btdm@text}
\setbeamercolor{bibliography item}{fg=btdm@text}
\setbeamercolor{background canvas}{bg=btdm@background}%
\setbeamercolor{normal text}{fg=btdm@text}
\setbeamercolor{frametitle}{parent=structure,fg=btdm@frametitle,bg=btdm@border@up}

\setbeamercolor{footline}{bg=btdm@border@down,fg=btdm@foot}
\setbeamercolor{page number in head/foot}{parent=footline,fg=btdm@foot!75!darkgray}

\setbeamersize{text margin left=6mm,text margin right=6mm}

\def\updateitemize#1{\setbeamertemplate{itemize items}{#1}%
\settowidth\leftmargini{\usebeamertemplate{itemize items}}%
\addtolength\leftmargini{\labelsep}}
\def\updateitemizesub#1{\setbeamertemplate{itemize subitem}{#1}%
\settowidth\leftmarginii{\usebeamertemplate{itemize subitem}}%
\addtolength\leftmarginii{\labelsep}}

\updateitemize{\mdseries\faAngleRight}
\updateitemizesub{\raisebox{1.5pt}{\scalebox{.45}{\mdseries\faCircleO}}}

% this code is based on that of dividing-lines but modified.
% if i have the time i will regroup it as a package
% idee, zeige Auszug 'C > D > E > F > G' für 'Abschnitt E',
% zeige allgemein immer 5 und versuche aktuelle section zu zentrieren
\AtBeginDocument{%
    \ifnum\value{btdm@sectioncount}<4\relax
        \let\btdm@sectionmax@target@preview\thebtdm@sectioncount
    \else
        \edef\btdm@sectionmax@target@preview{4}%
    \fi
}

\def\btdm@footer@tsymb#1{\hyperlink{btdm@slide@marker.#1}{\strut\ifnum\insertframenumber=#1\relax\(\blacklozenge\)\else\(\lozenge\)\fi}}
\def\btdm@printshort@lowforsec#1{\@nameuse{btdm@section@#1@content}}

\def\btdm@printshort@border{~~} % todo make customizable with hfill for center option so that id does not jump on clip and allow the section count displayed to be changeable (autochange?)
\def\btdm@printshort@mid{~~}

% we use very flat icons as sort of banners
\def\btdm@sub#1{\pgfpicture
\color{btdm@foot!55!btdm@background}
\pgfsetcornersarced{\pgfpoint{.2mm}{.2mm}}
\pgfpathrectanglecorners{\pgfpoint{-.9mm}{-.2mm}}{\pgfpoint{.9mm}{.2mm}}
\pgfusepath{#1}
\endpgfpicture}
\newsavebox\btdm@subs@off \setbox\btdm@subs@off=\hbox{\btdm@sub{stroke}}
\newsavebox\btdm@subs@on \setbox\btdm@subs@on=\hbox{\btdm@sub{stroke,fill}}
\let\btdm@sub\relax
\def\btdm@subsections@low#1{{% #1 is the section to filter
\beamer@currentsubsection=0%
\def\sectionentry##1##2##3##4##5{}%
\def\slideentry##1##2##3##4##5##6{\ifnum##6=\c@part\ifnum##1=#1
    \ifnum##2>\beamer@currentsubsection
    \beamer@currentsubsection=##2%
    \box\beamer@sectionbox\hskip1.25ex%
    \setbox\beamer@sectionbox=% we always disable on last
    \hbox{\beamer@link(##4){\ifnum\insertframenumber=\btdm@inserttotalframenumber \usebox\btdm@subs@off\else\ifnum\c@subsection=##2\ifnum##1=\c@section\relax\usebox\btdm@subs@on\else\usebox\btdm@subs@off\fi\else\usebox\btdm@subs@off\fi\fi}}%
    \ht\beamer@sectionbox=.3ex%
    \dp\beamer@sectionbox=.25ex%
    \fi\fi\fi\ignorespaces}%
\hskip.1mm\setbox\beamer@sectionbox=\hbox{}%
\hskip-1.25ex\dohead
\box\beamer@sectionbox\hfil\hskip.1mm}}

\newsavebox\btdm@box@lowforsec
\def\btdm@typesetfiveforcurrent@footfade{%
\ifnum\i>\btdm@sectionmax@target@start
\pgfmathsetmacro\btdm@disttotarget{int(min(100,max(5,30*abs(\i-\value{section}))))}%
\pgfmathsetmacro\btdm@disttotarget@last{int(min(100,max(5,30*abs(\i-\value{section}-1))))}%
{\btdm@printshort@mid\color{lightgray!\btdm@disttotarget@last!darkgray}\mdseries\,\faAngleRight\,}\btdm@printshort@mid\fi
\color{lightgray!\btdm@disttotarget!darkgray}}

\def\btdm@typesetfiveforcurrent{%
\setbox\@tempboxa=\hbox{\vphantom{\textbf{A}}}%
\ifnum\btdm@sectionmax@target@preview>0
    % get start index as sec-2
    \pgfmathsetmacro\btdm@sectionmax@target@start{int(max(1,\value{section}-2))}%
    \pgfmathsetmacro\btdm@sectionmax@target@end{int(min(\value{btdm@sectioncount},\btdm@sectionmax@target@start+\btdm@sectionmax@target@preview))}%
    % try to update lower if upper was capped
    \pgfmathsetmacro\btdm@sectionmax@target@start{int(max(1,\btdm@sectionmax@target@end-\btdm@sectionmax@target@preview))}%
    \btdm@footer@tsymb{1}~~\btdm@printshort@border
    % start: \btdm@sectionmax@target@start, end: \btdm@sectionmax@target@end
    \foreach \i in {\btdm@sectionmax@target@start,...,\btdm@sectionmax@target@end} {%
        \ifbtdm@footfade@
            \btdm@typesetfiveforcurrent@footfade
        \else\ifnum\i>\btdm@sectionmax@target@start\btdm@printshort@mid{\thinspace~\mdseries\faAngleRight~}\btdm@printshort@mid\fi\fi
        \setbox\btdm@box@lowforsec=\hbox{\btdm@printshort@lowforsec{\i}}%
        % note: we always calc the non(semi)bold thickness
        % \ifnum\value{section}=\i % old secton guard
        \let\btdm@thesec\thesection
        \@tempdima=\dimexpr\wd\btdm@box@lowforsec+.5em\relax
        % we rlap them by setting them to the right
        \hb@xt@\z@{\smash{\tiny\@declaredcolor{lightgray}\raisebox{\dimexpr-\ht\btdm@box@lowforsec+.23ex}{\hskip.5\@tempdima\relax\hb@xt@\z@{\hss\btdm@subsections@low{\i}\hss}}}\hss}\ifnum\value{section}=\i \usebeamerfont{active section in head/foot}\fi
        \parbox\@tempdima{\centering\hyperlink{btdm@section.\i}{\usebox\@tempboxa\smash{\btdm@printshort@lowforsec{\i}}}}% we erase all depth to allow sublinks to be clicked more easily
    }%
    \btdm@printshort@border~~\btdm@footer@tsymb{\btdm@inserttotalframenumber}%
\fi}

\def\btdm@footline@data{\btdm@typesetfiveforcurrent}

% inject sections
\newcounter{btdm@sectioncount}
\setcounter{btdm@sectioncount}{0}
\let\oldsection\section

\def\btdmcustomauxdef#1#2{\expandafter\gdef\csname btdm@section@#1@content\endcsname{#2}}
% we do not record star sections
\def\section{\@ifstar{\oldsection*}{\@xdblarg\btdm@section}}
\def\btdm@section[#1]#2{%
    \write\@auxout{\noexpand\global\noexpand\stepcounter{btdm@sectioncount}\noexpand\btdmcustomauxdef{\thesection}{#1}}%
    \ifx!#1!\oldsection{#2}\else\oldsection[#1]{#2}\fi\hypertarget{btdm@section.\thesection}{}%
}

\usenavigationsymbolstemplate{}
\newif\ifdmfoot \dmfoottrue
\def\revealfooton#1{\only<-\the\numexpr#1-1|handout:0>{\global\dmfootfalse}\only<#1->{\global\dmfoottrue}}
% allows to display foot on animations
\let\btdm@footbottomleft\@empty%
\def\setfootmarker#1{\def\btdm@footbottomleft{#1}}
\def\btdm@bottomtoc@w{.7\paperwidth}
%{\insertshortauthor~| \insertshortdate~ }% Todo allow for stuff like tut
\setbeamertemplate{footline}{\ifdmfoot
\beamercolorbox[wd=\paperwidth,leftskip=\z@,rightskip=\z@,center,ht=4.5ex,sep=3pt,shadow=false]{footline}% default color
    \strut\minipage{\dimexpr\paperwidth-.5cm}%
    \usebeamerfont{page number in head/foot}%
    \mbox{\btdm@footbottomleft}\hfill
    \parbox\btdm@bottomtoc@w{\centering\smaller\btdm@footline@data}% TODO: configure width
    \hskip3em% we pad solid right so that it does not jump  6em should be enough space
    \makebox[6em][r]{\strut\textbf{\usebeamercolor*[fg]{page number in head/foot}{\color{btdm@primary}\insertframenumber}\ifnum\insertframestartpage=\insertframeendpage\else{.\insertslidenumber}\fi}\,/\,\btdm@inserttotalframenumber}%
    \endminipage\strut
\endbeamercolorbox\fi}

% TODO: make this a customizable end slide so that i can have more fun with it and the penguins
\let\btdmbibfont\footnotesize
\def\printBibCommand{\renewcommand*{\bibfont}{\btdmbibfont}\printbibliography[title={},heading=none,notcategory={@hide},locallabelwidth]}

\AtEndPreamble{%
\@ifundefined{ver@biblatex.sty}{}{%
    \ifbtdm@bibliography@\btdm@setup@bib\fi
}}

\def\btdm@setup@bib{%
\let\finentrypunct\@empty
\def\btdm@lhook##1{\href{\thefield{url}}{##1}}%
\DeclareBibliographyDriver{btdm@bibtheme}{%
    \let\@tmp\@empty
    \ifhyperref{\iffieldundef{url}{}{\let\@tmp\btdm@lhook}}{}%
    \@tmp{\usebibmacro{bibindex}%
    \usebibmacro{begentry}%
    \usebibmacro{author/editor}%
    \setunit{\labelnamepunct}\newblock
    \usebibmacro{title}%
    \newblock
    \printtext{\space}% so it will be executed in sync
    \mbox{\textcolor{btdm@softtext}{\usebibmacro{date}}}%
    \newblock
    \usebibmacro{finentry}}}%
\DeclareBibliographyAlias{article}{btdm@bibtheme}%
\DeclareBibliographyAlias{book}{btdm@bibtheme}%
\DeclareBibliographyAlias{booklet}{btdm@bibtheme}%
\DeclareBibliographyAlias{collection}{btdm@bibtheme}%
\DeclareBibliographyAlias{inbook}{btdm@bibtheme}%
\DeclareBibliographyAlias{incollection}{btdm@bibtheme}%
\DeclareBibliographyAlias{inproceedings}{btdm@bibtheme}%
\DeclareBibliographyAlias{manual}{btdm@bibtheme}%
\DeclareBibliographyAlias{misc}{btdm@bibtheme}%
\DeclareBibliographyAlias{online}{btdm@bibtheme}%
\DeclareBibliographyAlias{patent}{btdm@bibtheme}%
\DeclareBibliographyAlias{periodical}{btdm@bibtheme}%
\DeclareBibliographyAlias{proceedings}{btdm@bibtheme}%
\DeclareBibliographyAlias{report}{btdm@bibtheme}%
\DeclareBibliographyAlias{thesis}{btdm@bibtheme}%
\DeclareBibliographyAlias{unpublished}{btdm@bibtheme}%
\DeclareBibliographyAlias{*}{btdm@bibtheme}%
\DeclareNameFormat{btdm@blx@nf}{\namepartfamily}%
\DeclareFieldFormat{btdm@sb@title}{\textit{##1}}%
\DeclareCiteCommand\btdm@sb@rawcite
{\citetrackerfalse\pagetrackerfalse
\usebibmacro{prenote}}%
{\ifciteindex{\indexfield{indextitle}}{}%
\let\@tmp\@empty
\ifhyperref{\iffieldundef{url}{}{\let\@tmp\btdm@lhook}}{}%
\@tmp{%
\printfield[btdm@sb@title]{labeltitle}\hfill\null\nobreak\hfill\nobreak\mbox{\textcolor{gray}{\printnames[btdm@blx@nf][1-1]{author},~\printfield{year}}}%
}}%
{\multicitedelim}%
{\usebibmacro{postnote}}%
\DeclareBibliographyCategory{@hide}%
}

\def\btdm@outro{}
\def\outro#1{\gdef\btdm@outro{#1}}
\def\btdm@email{}
\def\email#1{\gdef\btdm@email{#1}}
\def\btdm@postpage{} \def\PostPage#1{\def\btdm@postpage{#1}}
% we have to fake the totals because at end document is not recorded
\def\btdm@inserttotalframenumber{\the\numexpr\inserttotalframenumber+1\relax}
\AtEndDocument{%
\begingroup
\setfootmarker{\insertauthoremail~| \insertshortdate~}%
\begin{frame}[c]%
\label{btdm@slide@marker.\btdm@inserttotalframenumber}% the important end marker
\fontseries{medium}%
\btdm@outro\relax
\btdm@postpage
\end{frame}
\endgroup
}
% TODO: deal with overfull hboxes

\def\btdm@righttitle{}
\def\setrightitle#1{\def\btdm@righttitle{#1}}
\newdimen\btdm@vertshift \btdm@vertshift=1.5mm
\defbeamertemplate*{frametitle}{digital-minimal}[1][]{%
\vskip\btdm@vertshift% l margin is the left margin so it is aligned with the text
\usebeamerfont{frametitle}\strut\beamercolorbox[wd=\paperwidth,leftskip=\z@,rightskip=\z@,center,ht=3.75ex,dp=.45ex,sep=2pt,shadow=false]{frametitle}% default color
\strut\minipage{\dimexpr\paperwidth-.5cm}%
\hskip.5mm\usebeamercolor*[fg]{frametitle}\strut\insertframetitle
\endminipage
% currently we do this recalculation for one single reason: the font size could change mid-document
\ifbtdm@largetrig@
   % size, y shift and x shift
   \@tempdima=\dimexpr3.75ex+.45ex+3.85pt+1.3\btdm@vertshift\relax
   \@tempdimb=\dimexpr-3.75ex/2-1.45pt-.65\btdm@vertshift\relax
   \@tempdimc=\dimexpr-.25cm-.4ex\relax
\else
   \@tempdima=\dimexpr3.75ex+.45ex+4.05pt\relax
   \@tempdimb=\dimexpr-3.75ex/2-.94pt\relax
   \@tempdimc=\dimexpr-.25cm-.25ex\relax
\fi
\setbox0=\hbox{\resizebox*!\@tempdima{\@declaredcolor{btdm@block}\mdseries\faCaretLeft}}%
\llap{\smash{\raisebox\@tempdimb{\usebox0}}\hskip\@tempdimc}\llap{\btdm@righttitle}\strut
\endbeamercolorbox
}

\def\titlenumber#1{\def\btdm@titlepage@number{#1}}
\let\btdm@titlepage@number\@empty

\defbeamertemplate*{title page}{digital-minimal}[1][]{%
\smash{\hskip\textwidth\llap{\raisebox{-.5\height}{\@declaredcolor{btdm@softtext}\fontsize{72pt}{72pt}\btdm@sbseries\btdm@titlepage@number}}}\vfill
\begin{center}
\parskip=\medskipamount
    {\usebeamerfont{title}\usebeamercolor*[fg]{title}\inserttitle}\par
    {\usebeamerfont{subtitle}\usebeamercolor*[fg]{subtitle}\insertsubtitle}\relax
\end{center}
\vfill\null}


\def\setauthormailsubject#1{\def\btdm@authormailsuff{?Subject=#1}}
\let\btdm@authormailsuff\@empty
\def\insertauthoremail{\ifx\btdm@email\@empty\insertauthor\else\href{mailto:\btdm@email\btdm@authormailsuff}{\insertauthor}\fi}

\newcommand\titleframe[1][]{% post tilepage
% default reveal
\begingroup % keep local
\setfootmarker{\insertauthoremail~| \insertshortdate~}%
\begin{frame}[c]
   \label{btdm@slide@marker.1}%
   \revealfooton{2}% can be overriden
   \titlepage#1
\end{frame}
\endgroup
}
\endinput