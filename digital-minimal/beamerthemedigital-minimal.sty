%% Version: 1.0
%% Author:  Florian Sihler, 3.02.2021
%% This package is a beamer theme to be used with the latex beamer-class.
%% Dev-Notes: All internal commands and registers will be prefixed with 'btdm@'
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{beamerthemedigital-minimal}[2019/08/17 v1.0.0 Latex-Beamertheme digital-minimal]

% die idee: gaanz unten ein dünner grauer block der alle Metainformationen enthält, oben nur ein Titel
% break Folien für Sections mit simpler Dreiecks optic und übersicht über TOC -- neues Tut design

\newif\ifbtdm@footfade@
\DeclareOption{nofootfade}{\btdm@footfade@false} \DeclareOption{footfade}{\btdm@footfade@true}
\ProcessOptions

\RequirePackage[defaultfam,light,tabular,lining]{montserrat}
\def\sbfamily{\fontseries{sb}\selectfont}

\RequirePackage{sfmath} % TODO: no-libs option
% TODO: titlepage

\RequirePackage{relsize}

\RequirePackage{tikz} % i do need it... always :)
\RequirePackage{fontawesome} % foot symbols

\colorlet{btdm@primary}{purple!80!teal} % todo
\setbeamercolor{palette primary}{fg=btdm@primary}

\colorlet{btdm@text}{black!99!gray}
\setbeamercolor{structure}{fg=btdm@primary}
\setbeamercolor{description item}{fg=btdm@text}
\setbeamercolor{bibliography item}{fg=btdm@text}
\colorlet{btdm@background}{white!99!gray}
\setbeamercolor{background canvas}{bg=btdm@background}%
\setbeamercolor{normal text}{fg=btdm@text}
\setbeamerfont{structure}{family=\sbfamily}
\setbeamercolor{structure-title}{parent=structure,fg=white!99!btdm@primary,bg=btdm@primary}
\setbeamerfont{strcuture-title}{parent=structure,size=\LARGE}
% this code is based on that of dividing-lines but modified.
% if i have the time i will regroup it as a package
% idee, zeige Auszug 'C > D > E > F > G' für 'Abschnitt E',
% zeige allgemein immer 5 und versuche aktuelle section zu zentrieren
\AtBeginDocument{%
    \pgfmathsetmacro\btdm@sectionmax@target@preview{int(min(4,\arabic{btdm@sectioncount}))}%
}

\def\btdm@footer@tsymb#1{\hyperlink{btdm@slide@marker.#1}{\strut\ifnum\insertframenumber=#1\relax\(\blacklozenge\)\else\(\lozenge\)\fi}}
\def\btdm@printshort@lowforsec#1{\@nameuse{btdm@section@#1@content}}

\def\btdm@printshort@border{~~} % todo make customizable with hfill for center option so that id does not jump on clip and allow the section count displayed to be changeable (autochange?)
\def\btdm@printshort@mid{~~}

% we use very flat icons as sort of banners
\newsavebox\btdm@subs@off \savebox\btdm@subs@off{\tikz{\path[draw,lightgray!70!white,rounded corners=.2mm] (-.09,-.02) rectangle (.09,.02);}}
\newsavebox\btdm@subs@on \savebox\btdm@subs@on{\tikz{\path[fill,draw,lightgray!70!white,rounded corners=.2mm] (-.09,-.02) rectangle (.09,.02);}}
\def\btdm@subsections@low#1{{% #1 is the section to filter
\beamer@currentsubsection=0%
\def\sectionentry##1##2##3##4##5{}%
\def\slideentry##1##2##3##4##5##6{\ifnum##6=\c@part\ifnum##1=#1
    \ifnum##2>\beamer@currentsubsection
    \beamer@currentsubsection=##2%
    \box\beamer@sectionbox\hskip1.25ex%
    \setbox\beamer@sectionbox=%
    \hbox{\beamer@link(##4){\ifnum\c@subsection=##2\ifnum##1=\c@section\relax\usebox\btdm@subs@on\else\usebox\btdm@subs@off\fi\else\usebox\btdm@subs@off\fi}}%
    \ht\beamer@sectionbox=.3ex%
    \dp\beamer@sectionbox=.25ex%
    \fi\fi\fi\ignorespaces}%
\hskip1mm\setbox\beamer@sectionbox=\hbox{}%
\hskip-1.25ex\dohead
\box\beamer@sectionbox\hfil\hskip.1mm}}

\newsavebox\btdm@box@lowforsec
\def\btdm@typesetfiveforcurrent{%
\ifnum\btdm@sectionmax@target@preview>0
    % get start index as sec-2
    \pgfmathsetmacro\btdm@sectionmax@target@start{int(max(1,\value{section}-2))}%
    \pgfmathsetmacro\btdm@sectionmax@target@end{int(min(\value{btdm@sectioncount},\btdm@sectionmax@target@start+\btdm@sectionmax@target@preview))}%
    % try to update lower if upper was capped
    \pgfmathsetmacro\btdm@sectionmax@target@start{int(max(1,\btdm@sectionmax@target@end-\btdm@sectionmax@target@preview))}%
    \btdm@footer@tsymb{1}~~\btdm@printshort@border
    % start: \btdm@sectionmax@target@start, end: \btdm@sectionmax@target@end
    \foreach \i in {\btdm@sectionmax@target@start,...,\btdm@sectionmax@target@end} {%
        \ifbtdm@footfade@
        \pgfmathsetmacro\btdm@disttotarget{int(min(100,max(5,30*abs(\i-\value{section}))))}%
        \ifnum\i>\btdm@sectionmax@target@start
            \pgfmathsetmacro\btdm@disttotarget@last{int(min(100,max(5,30*abs(\i-\value{section}-1))))}%
            {\btdm@printshort@mid\color{lightgray!\btdm@disttotarget@last!darkgray}\,\faAngleRight\,}\btdm@printshort@mid\fi
        \color{lightgray!\btdm@disttotarget!darkgray}%
        \else\ifnum\i>\btdm@sectionmax@target@start\btdm@printshort@mid{\thinspace~\faAngleRight\thinspace}\btdm@printshort@mid\fi\fi
        \savebox\btdm@box@lowforsec{\btdm@printshort@lowforsec{\i}} % intentional space
        % note: we always calc the non(semi)bold thickness
        % \ifnum\value{section}=\i % old secton guard
        \let\btdm@thesec\thesection
        \hb@xt@\z@{\smash{\tiny\@declaredcolor{lightgray}\raisebox{\dimexpr-\ht\btdm@box@lowforsec+.2ex}{\hskip.5\wd\btdm@box@lowforsec\relax\hb@xt@\z@{\hss\btdm@subsections@low{\i}\hss}}}}\ifnum\value{section}=\i \sbfamily\fi % todo ubs for all?
        \parbox{\dimexpr\wd\btdm@box@lowforsec+.5em}{\hyperlink{btdm@section.\i}{\vphantom{A}\smash{\btdm@printshort@lowforsec{\i}}}}% we erase all depth to allow sublinks to be clicked more easily
    }%
    \btdm@printshort@border~~\btdm@footer@tsymb{\btdm@inserttotalframenumber}%
\fi}

\def\btdm@footline@data{\btdm@typesetfiveforcurrent}

% inject sections
\newcounter{btdm@sectioncount}
\setcounter{btdm@sectioncount}{0}
\let\oldsection\section

\def\btdmcustomauxdef#1#2{\expandafter\gdef\csname btdm@section@#1@content\endcsname{#2}}

\def\section{\@xdblarg\btdm@section}
\def\btdm@section[#1]#2{%
    \write\@auxout{\noexpand\global\noexpand\stepcounter{btdm@sectioncount}\noexpand\btdmcustomauxdef{\thesection}{#1}}%
    \ifx!#1!\oldsection{#2}\else\oldsection[#1]{#2}\fi\hypertarget{btdm@section.\thesection}{}%
}


\setbeamercolor{foot-structure}{bg=lightgray!10!white,fg=gray}
\setbeamercolor{foot-page-structure}{parent=foot-structure,fg=gray!75!darkgray}

\usenavigationsymbolstemplate{}
\newif\ifdmfoot \dmfoottrue
\def\revealfooton#1{\only<-\the\numexpr#1-1|handout:0>{\global\dmfootfalse}\only<#1->{\global\dmfoottrue}}
% allows to display foot on animations
\def\dmfootbottomleft{\insertshortauthor~| \insertshortdate~ }% Todo allow for stuff like tut
\setbeamertemplate{footline}{\ifdmfoot
\beamercolorbox[wd=\paperwidth,leftskip=\z@,rightskip=\z@,center,ht=4ex,sep=2pt,shadow=false]{foot-structure}% default color
    \strut\minipage{\dimexpr\paperwidth-.5cm}%
    \usebeamerfont{page number in head/foot}%
    \mbox{\dmfootbottomleft}\hfill
    \parbox{.6\paperwidth}{\centering\smaller\btdm@footline@data}% TODO: configure width
    \hfill% 6em should be enough space
    \makebox[6em][r]{\strut\textbf{\usebeamercolor[fg]{foot-page-structure}\insertframenumber\ifnum\insertframestartpage=\insertframeendpage\else{\smaller[2].\insertslidenumber}\fi}\smaller\,/\,\btdm@inserttotalframenumber}%
    \endminipage\strut
\endbeamercolorbox\fi}

% TODO: make this a customizable end slide so that i can have more fun with it and the penguins
\let\btdmbibfont\footnotesize
\def\printBibCommand{\renewcommand*{\bibfont}{\btdmbibfont}\printbibliography[title={},heading=none,notcategory={@hide},locallabelwidth,resetnumbers]}

\AtEndPreamble{%
\@ifundefined{ver@biblatex.sty}{}{%
    \btdm@setup@bib
}}

\def\btdm@setup@bib{%
\let\finentrypunct\@empty
\def\btdm@lhook##1{\href{\thefield{url}}{##1}}%
\DeclareBibliographyDriver{btdm@bibtheme}{%
    \let\@tmp\@empty
    \ifhyperref{\iffieldundef{url}{}{\let\@tmp\btdm@lhook}}{}%
    \@tmp{\usebibmacro{bibindex}%
    \usebibmacro{begentry}%
    \usebibmacro{author/editor}%
    \setunit{\labelnamepunct}\newblock
    \usebibmacro{title}%
    \newblock
    \printtext{\space}% so it will be executed in sync
    \mbox{\textcolor{btdm@primary!35!white}{\usebibmacro{date}}}%
    \newblock
    \usebibmacro{finentry}}}%
\DeclareBibliographyAlias{article}{btdm@bibtheme}%
\DeclareBibliographyAlias{book}{btdm@bibtheme}%
\DeclareBibliographyAlias{booklet}{btdm@bibtheme}%
\DeclareBibliographyAlias{collection}{btdm@bibtheme}%
\DeclareBibliographyAlias{inbook}{btdm@bibtheme}%
\DeclareBibliographyAlias{incollection}{btdm@bibtheme}%
\DeclareBibliographyAlias{inproceedings}{btdm@bibtheme}%
\DeclareBibliographyAlias{manual}{btdm@bibtheme}%
\DeclareBibliographyAlias{misc}{btdm@bibtheme}%
\DeclareBibliographyAlias{online}{btdm@bibtheme}%
\DeclareBibliographyAlias{patent}{btdm@bibtheme}%
\DeclareBibliographyAlias{periodical}{btdm@bibtheme}%
\DeclareBibliographyAlias{proceedings}{btdm@bibtheme}%
\DeclareBibliographyAlias{report}{btdm@bibtheme}%
\DeclareBibliographyAlias{thesis}{btdm@bibtheme}%
\DeclareBibliographyAlias{unpublished}{btdm@bibtheme}%
\DeclareBibliographyAlias{*}{btdm@bibtheme}%
\DeclareNameFormat{btdm@blx@nf}{\namepartfamily}%
\DeclareFieldFormat{btdm@sb@title}{\textit{##1}}%
\DeclareCiteCommand\btdm@sb@rawcite
{\citetrackerfalse\pagetrackerfalse
\usebibmacro{prenote}}%
{\ifciteindex{\indexfield{indextitle}}{}%
\let\@tmp\@empty
\ifhyperref{\iffieldundef{url}{}{\let\@tmp\btdm@lhook}}{}%
\@tmp{%
\printfield[btdm@sb@title]{labeltitle}\hfill\null\nobreak\hfill\nobreak\mbox{\textcolor{gray}{\printnames[btdm@blx@nf][1-1]{author},~\printfield{year}}}%
}}%
{\multicitedelim}%
{\usebibmacro{postnote}}%
\DeclareBibliographyCategory{@hide}%
}

\def\btdm@outro{}
\def\outro#1{\gdef\btdm@outro{#1}}
\def\btdm@email{}
\def\email#1{\gdef\btdm@email{#1}}
\def\btdm@outro@right{} \def\outroright#1{\gdef\btdm@outro@right{#1}}
\def\btdm@postpage{} \def\PostPage#1{\def\btdm@postpage{#1}}
% we have to fake the totals because at end document is not recorded:
\def\btdm@inserttotalframenumber{\the\numexpr\inserttotalframenumber+1\relax}
\AtEndDocument{%
\begingroup
\begin{frame}[c]%
\label{btdm@slide@marker.\btdm@inserttotalframenumber}% the important end marker
\fontseries{medium}%
\vfill\pgfmathsetmacro\btdm@extlenw{\textwidth+2em}
\hspace*{-1em}\parbox{\btdm@extlenw pt}{\parbox[b]{.35\textwidth}{%
    {\small\ifx\btdm@outro@right\@empty\textbf{\insertauthor}\else\href{mailto:\btdm@email}{\textbf{\insertauthor}}\fi}\\
    {\footnotesize\btdm@outro{}}%
}\hfill\parbox[b]{.35\textwidth}{%
{\hbox{}\hfill\footnotesize\ifx\btdm@outro@right\@empty\href{mailto:\btdm@email}{\btdm@email}\else\btdm@outro@right\fi}%
}}%
\btdm@postpage
\end{frame}
\endgroup
}
% TODO: deal with overfull hboxes

\defbeamertemplate*{frametitle}{digital-minimal}[1][]{%
\vskip2mm\beamercolorbox[wd=\paperwidth,leftskip=\z@,rightskip=\z@,center,ht=3.55ex,dp=.45ex,sep=2pt,shadow=false]{structure-title}% default color
    \strut\minipage{\dimexpr\paperwidth-.5cm}%
      \usebeamerfont{structure-title}\strut\insertframetitle
    \endminipage\strut
\endbeamercolorbox\hspace*{-1cm}}
\endinput