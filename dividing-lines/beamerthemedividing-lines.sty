%% -----------------------------------------------------------------------------
%% Version: 1.0
%% Author:  Florian Sihler, 3.02.2021
%%
%% This package is a beamer theme to be used with the latex beamer-class.
%% Development notes:
%%    All internal commands and registers will be prefixed with 'btdl@'

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{beamerthemecolorful-dream}[2019/08/17 v1.0.0 Latex-Beamertheme colorful-dream]

%% packet options
%% -----------------------------------------------------------------------------
% footfade
\newif\ifbtdl@footfade@ \btdl@footfade@true
\DeclareOption{nofootfade}{\btdl@footfade@false} \DeclareOption{footfade}{\btdl@footfade@true}

\DeclareOption{nocenterfoot}{\def\btdl@printshort@mid{~\hfill}} \DeclareOption{centerfoot}{\def\btdl@printshort@mid{\quad}}

% libs
\newif\ifbtdl@loadlibs@ \btdl@loadlibs@true
\DeclareOption{nolibs}{\btdl@loadlibs@false} \DeclareOption{libs}{\btdl@loadlibs@true}

% bibliography
\newif\ifbtdl@bibliography@ \btdl@bibliography@true % default: yes/ifloaded
\DeclareOption{nobib}{\btdl@bibliography@false} \DeclareOption{showbib}{\btdl@bibliography@true}

\ExecuteOptions{nocenterfoot}
\ProcessOptions

%% load packages
%% -----------------------------------------------------------------------------

\RequirePackage[defaultfam,light,tabular,lining]{montserrat}
\def\sbfamily{\fontseries{sb}\selectfont}

% load libs
\ifbtdl@loadlibs@
\RequirePackage{sfmath,tikz,fontawesome,multicol,etoolbox,xstring,pbox}
\usetikzlibrary{calc,decorations.text}
\fi

%% the color profile
%% -----------------------------------------------------------------------------

% #1: primary, #2: secondary, #3: alerted
\newcommand*\SetColorProfile[3]{%
\definecolor{btdl@color@primary}{RGB}{#1}%
\definecolor{btdl@color@secondary}{RGB}{#2}%
\definecolor{btdl@color@alerted}{RGB}{#3}%
}

% RGB(249, 166, 2) RGB(254, 231, 130) RGB(137,64,75)
\SetColorProfile{249, 166, 2}{254, 231, 130}{137,64,75}

\definecolor{btdl@color@white}{RGB}{254,254,254}    % RGB(254,254,254)
\definecolor{btdl@color@black}{RGB}{009,009,009}    % RGB(009,009,009)

\colorlet{btdl@color@emblem}{gray}

\colorlet{btdl@color@wtext}{btdl@color@white!92!btdl@color@primary}
\colorlet{btdl@color@btext}{btdl@color@black}
\colorlet{btdl@color@text}{btdl@color@black!95!btdl@color@white}

\colorlet{btdl@solidF}{btdl@color@primary!25!btdl@color@black}

%% shortcut commands for the user
%% -----------------------------------------------------------------------------

\newcommand\hl[1]{\textcolor{btdl@color@secondary}{#1}}
\newcommand\imp[1]{\emph{#1}}

%% beamer configuration
%% -----------------------------------------------------------------------------
\setbeamercolor{background canvas}{bg=btdl@color@primary!1!}

% General
\setbeamercolor{normal text}{fg=btdl@color@btext}
\setbeamercolor{structure}{fg=btdl@color@text}
\setbeamercolor{alerted text}{fg=btdl@color@alerted}
\setbeamercolor{example text}{fg=btdl@color@white}
\setbeamercolor{copyright text}{fg=btdl@color@wtext}
\setbeamercolor{palette primary}{fg=btdl@color@btext}


% Titlepage
\setbeamercolor{title}{parent=normal text}
\setbeamercolor{subtitle}{parent=normal text}
\setbeamercolor{institute}{parent=normal text,fg=gray}

% Content
\setbeamercolor{frametitle}{}
\setbeamerfont{frametitle}{size=\Large,series=\mdseries}

% Page Number
\setbeamercolor{page number in head/foot}{fg=btdl@color@btext!50!btdl@color@white}

\setbeamerfont{title}{size=\fontsize{24}{24},series=\sbfamily}
\setbeamerfont{subtitle}{size=\fontsize{10}{12},series=\mdseries}
\setbeamerfont{institute}{size=\fontsize{8}{10},series=\mdseries}
\setbeamerfont{section title}{size=\fontsize{19}{19}}

\setbeamercolor{description item}{fg=btdl@color@black}

\setbeamercolor{enumerate item}{fg=btdl@color@black}
\setbeamercolor{enumerate subitem}{fg=btdl@color@black}
\setbeamercolor{enumerate subsubitem}{fg=btdl@color@black}

\setbeamerfont{section in toc}{size=\fontsize{12}{14}}
\setbeamerfont{subsection in toc}{size=\fontsize{8}{12}}
\setbeamerfont{disabled subsection in toc}{size=\fontsize{8}{12}}
\setbeamertemplate{section in toc}{\medskip\vfill\hbox{}\inserttocsection\par}

\setbeamertemplate{subsection in toc}{\qquad{\scalebox{0.65}{\raisebox{1.25pt}{$\blacksquare$}}}\hspace{1em}\inserttocsubsection\par}
\setbeamertemplate{disabled subsection in toc}{\color{gray}\qquad{\scalebox{0.65}{\raisebox{1.25pt}{$\blacksquare$}}}\hspace{1em}\inserttocsubsection\par}

% bibliography
\setbeamertemplate{bibliography entry title}{}
\setbeamertemplate{bibliography entry location}{}
\setbeamertemplate{bibliography entry note}{}
\setbeamercolor{bibliography item}{fg=btdl@color@white}
\setbeamercolor*{bibliography entry title}{fg=btdl@color@white}
\setbeamercolor{bibliography entry author}{fg=btdl@color@white}
\setbeamercolor*{bibliography entry author}{fg=btdl@color@white}
\setbeamercolor{bibliography entry location}{fg=btdl@color@white}
\setbeamercolor*{bibliography entry location}{fg=btdl@color@white}
\setbeamercolor{bibliography entry note}{fg=btdl@color@white}
\setbeamercolor*{bibliography entry note}{fg=btdl@color@white}
\setbeamertemplate{bibliography item}[text]


\setbeamertemplate{itemize items}{\scalebox{0.5}{\raisebox{3.66pt}{$\blacksquare$}}}
\setbeamertemplate{itemize subitem}{\tiny\tikz[baseline=-1.15ex]{\fill (0,0) circle (1.65pt);}}

\defbeamertemplate{description item}{colorful-dream}{\textsc{\small\insertdescriptionitem:}}
\setbeamertemplate{description item}[colorful-dream]

\setbeamercolor{block title}{use=structure,fg=btdl@color@white,bg=btdl@solidF}
\setbeamercolor{block body}{parent=normal text,use=block title,bg=block title.bg!10!bg}

\setbeamertemplate{theorems}[numbered]

\setbeamertemplate{theorem begin}{%
\begin{\inserttheoremblockenv}{\inserttheoremname\inserttheoremnumber%
    \ifx\inserttheoremaddition\@empty\else:\space\inserttheoremaddition\fi%
}%
}

%% head line
%% -----------------------------------------------------------------------------

\newlength{\btdl@leftindent} \btdl@leftindent=6.75em
\setbeamersize{sidebar width left=\btdl@leftindent}

\setbeamertemplate{frametitle}{%
    \nointerlineskip%
    \begin{beamercolorbox}[wd=\linewidth,ht=3.5ex,dp=1.75ex,leftskip=-\btdl@leftindent]{frametitle}%
     \usebeamerfont{frametitle}\parbox{\dimexpr\btdl@leftindent\relax}{\textbf{\color{btdl@color@primary}\insertframenumber}}\insertframetitle%
    \end{beamercolorbox}%
}

%% footer
%% -----------------------------------------------------------------------------

% idee, zeige Auszug   'C > D > E > F > G' fÃ¼r 'Abschnitt E',
% zeige allgemein immer 5 und versuche aktuelle section zu zentrieren

\AtBeginDocument{%
    \pgfmathsetmacro\btdl@sectionmax@target@preview{int(min(6,\arabic{btdl@sectioncount}))}%
}

\def\btdl@footer@tsymb#1{\hyperlink{btdl@section.#1}{\ifnum\value{section}=#1 \(\blacklozenge\)\else\(\lozenge\)\fi}}
\def\btdl@printshort@lowforsec#1{\@nameuse{btdl@section@#1@content}}
% def by op \def\btdl@printshort@mid{\hfill}
\def\btdl@printshort@border{\hfill}

\def\btdl@typesetfiveforcurrent{%
\ifnum\btdl@sectionmax@target@preview>0
    % get start index as sec-2
    \pgfmathsetmacro\btdl@sectionmax@target@start{int(max(1,\value{section}-2))}%
    \pgfmathsetmacro\btdl@sectionmax@target@end{int(min(\value{btdl@sectioncount},\btdl@sectionmax@target@start+\btdl@sectionmax@target@preview))}%
    % try to update lower if upper was capped
    \pgfmathsetmacro\btdl@sectionmax@target@start{int(max(1,\btdl@sectionmax@target@end-\btdl@sectionmax@target@preview))}%
    \btdl@footer@tsymb{\btdl@sectionmax@target@start}~~\btdl@printshort@border%
    % start: \btdl@sectionmax@target@start, end: \btdl@sectionmax@target@end
    \foreach \i in {\btdl@sectionmax@target@start,...,\btdl@sectionmax@target@end} {%
        \ifbtdl@footfade@
        \pgfmathsetmacro\btld@disttotarget{int(min(100,max(5,30*abs(\i-\value{section}))))}%
        \ifnum\i>\btdl@sectionmax@target@start
            \pgfmathsetmacro\btld@disttotarget@last{int(min(100,max(5,30*abs(\i-\value{section}-1))))}%
            {\color{lightgray!\btld@disttotarget@last!darkgray}\,~\faAngleRight\,}\btdl@printshort@mid\fi
        \color{lightgray!\btld@disttotarget!darkgray}%
        \else\ifnum\i>\btdl@sectionmax@target@start\btdl@printshort@mid{\,~\faAngleRight\,}\btdl@printshort@mid\fi\fi%
        \ifnum\value{section}=\i \sbfamily\fi
        \strut\hyperlink{btdl@section.\i}{\btdl@printshort@lowforsec{\i}}%
    }%
    \btdl@printshort@border~~\btdl@footer@tsymb{\btdl@sectionmax@target@end}%
\fi%
}

\def\btcd@footline@data{\btdl@typesetfiveforcurrent}

\usenavigationsymbolstemplate{}
\setbeamertemplate{footline}{%
    \begin{beamercolorbox}[wd=\dimexpr\textwidth-\beamer@rightmargin\relax,ht=3ex,dp=4ex,leftskip=\dimexpr\btdl@leftindent+\beamer@leftmargin\relax]{structure}% default color
        \color{gray}\usebeamerfont{page number in head/foot}%
        {\btcd@footline@data}%
    \end{beamercolorbox}%
}

%% start of setions
%% -----------------------------------------------------------------------------

\newif\ifsectionbanner \sectionbannertrue
\let\nosframe\sectionbannerfalse

\newcounter{btdl@sectioncount}
\setcounter{btdl@sectioncount}{0}
\let\oldsection\section

\def\btdlcustomauxdef#1#2{\expandafter\gdef\csname btdl@section@#1@content\endcsname{#2}}

\def\section{\@xdblarg\btdl@section}
\def\btdl@section[#1]#2{%
    \write\@auxout{\noexpand\global\noexpand\stepcounter{btdl@sectioncount}\noexpand\btdlcustomauxdef{\thesection}{#1}}%
    \ifx!#1!\oldsection{#2}\else\oldsection[#1]{#2}\fi\hypertarget{btdl@section.\thesection}{}%
}

%% titleimage
%% -----------------------------------------------------------------------------
\newsavebox\btdl@box@title

\def\tag#1{\gdef\btdl@tag{#1}}
\def\btdl@tag{}
\def\btdl@subbox@len{1em}
\newsavebox\btdl@box@subbox
\def\tagline{%
    \ifundef{\insertauthor}{}{%
    \savebox\btdl@box@subbox{\color{btdl@color@primary}\scriptsize\sbfamily\ifdefempty{\btdl@email}{\insertauthor}{\href{mailto:\btdl@email}{\insertauthor}}}\xdef\btdl@subbox@len{\wd\btdl@box@subbox}}%
    \tikz{%
    \begin{pgfinterruptboundingbox}
        \draw[btdl@color@primary, line width=1pt,line cap=round] (0,0) -- (\wd\btdl@box@title,0) coordinate (rslin-end);
            \node[below left,inner xsep=0pt,outer xsep=0pt] at (rslin-end) {\usebox{\btdl@box@subbox}};
        \end{pgfinterruptboundingbox}
    }%
}

\setbeamertemplate{title page}{%
\savebox\btdl@box@title{%
    \pbox{0.95\linewidth}{%
        \usebeamerfont{title}\usebeamercolor{title}\MakeUppercase{\inserttitle}%
    }%
}\parskip\z@ \parindent\z@ %
    {\usebox{\btdl@box@title}\par}
    {\tagline\par}
    \parbox[t]{\wd\btdl@box@title-\btdl@subbox@len}{\usebeamerfont{subtitle}\usebeamercolor{subtitle}\insertsubtitle}\par\vfill%
    \parbox[b][0pt]{\linewidth}{%
        \raggedleft\color{gray}\usebeamerfont{institute}\usebeamercolor{institute}%
        \ifdefempty{\btdl@tag}{}{\btdl@tag\leavevmode\\}
        \ifundef{\insertdate}{}{\insertdate\leavevmode\\}
        \insertinstitute\par
    }
}

\AtBeginDocument{%
\begingroup
\begin{frame}[plain,b]%
    \hspace*{-\btdl@leftindent}\begin{minipage}[b][.75\textheight]{\textwidth+\btdl@leftindent}
    \titlepage%
    \end{minipage}
\end{frame}%
\endgroup
}

%% outro
%% -----------------------------------------------------------------------------

\def\btdl@outro{}
\def\outro#1{\gdef\btdl@outro{#1}}

\def\btdl@email{}
\def\email#1{\gdef\btdl@email{#1}}

\def\printBibCommand{\renewcommand*{\bibfont}{\footnotesize}\printbibliography[title={}]}

\AtEndDocument{
\begingroup%
\setbeamercolor{background canvas}{bg=btdl@color@primary}%
\begin{frame}[plain,t]%
\hspace*{-\btdl@leftindent}\begin{minipage}[c][\textheight]{\textwidth+\btdl@leftindent}
\color{btdl@color@white}%
\@ifundefined{ver@biblatex.sty}{}{%
    \ifbtdl@bibliography@%
        \vspace*{2em}%
        \defbibheading{bibliography}[\refname]{}%
        \bgroup\sectionbannerfalse\printBibCommand\egroup\hbox{}\vfill\hbox{}%
    \fi%
}%
\vfill\pgfmathsetmacro\btdl@extlenw{\textwidth+2em}
\hspace*{-1em}\parbox{\btdl@extlenw pt}{\parbox[b]{0.35\textwidth}{%
    {\small\textbf{\insertauthor}}\\
    {\footnotesize\btdl@outro{}}%
}\hfill\parbox[b]{0.35\textwidth}{%
{\hbox{}\hfill\footnotesize\href{mailto:\btdl@email}{\btdl@email}}%
}}\vspace*{-1em}%
\end{minipage}
\end{frame}
\endgroup
}

\endinput